//
// Created by cwuom on 17 Feb 2026.
//


#pragma once
#include <ntddk.h>

// ==============================================================================
// Reference: Intel SDM Vol. 3C Appendix B, Intel SDM Vol. 4
// ==============================================================================

#define CR4_VMXE (1ULL << 13)

// MSR Index
#define MSR_IA32_FEATURE_CONTROL        0x0000003A
#define MSR_IA32_VMX_BASIC              0x00000480
#define MSR_IA32_VMX_PINBASED_CTLS      0x00000481
#define MSR_IA32_VMX_PROCBASED_CTLS     0x00000482
#define MSR_IA32_VMX_EXIT_CTLS          0x00000483
#define MSR_IA32_VMX_ENTRY_CTLS         0x00000484
#define MSR_IA32_VMX_MISC               0x00000485
#define MSR_IA32_VMX_CR0_FIXED0         0x00000486
#define MSR_IA32_VMX_CR0_FIXED1         0x00000487
#define MSR_IA32_VMX_CR4_FIXED0         0x00000488
#define MSR_IA32_VMX_CR4_FIXED1         0x00000489
#define MSR_IA32_VMX_PROCBASED_CTLS2    0x0000048B
#define MSR_IA32_VMX_TRUE_PINBASED_CTLS 0x0000048D
#define MSR_IA32_VMX_TRUE_PROCBASED_CTLS 0x0000048E
#define MSR_IA32_VMX_TRUE_EXIT_CTLS     0x0000048F
#define MSR_IA32_VMX_TRUE_ENTRY_CTLS    0x00000490
#define MSR_FS_BASE                     0xC0000100
#define MSR_GS_BASE                     0xC0000101
#define MSR_IA32_EFER                   0xC0000080
#define MSR_IA32_SYSENTER_CS            0x00000174
#define MSR_IA32_SYSENTER_ESP           0x00000175
#define MSR_IA32_SYSENTER_EIP           0x00000176
#define MSR_IA32_PAT                    0x00000277

// VMCS Fields
enum VmcsField : ULONG {
    // 16-Bit Guest State
    GUEST_ES_SELECTOR = 0x800,
    GUEST_CS_SELECTOR = 0x802,
    GUEST_SS_SELECTOR = 0x804,
    GUEST_DS_SELECTOR = 0x806,
    GUEST_FS_SELECTOR = 0x808,
    GUEST_GS_SELECTOR = 0x80a,
    GUEST_LDTR_SELECTOR = 0x80c,
    GUEST_TR_SELECTOR = 0x80e,

    // 16-Bit Host State
    HOST_ES_SELECTOR = 0xc00,
    HOST_CS_SELECTOR = 0xc02,
    HOST_SS_SELECTOR = 0xc04,
    HOST_DS_SELECTOR = 0xc06,
    HOST_FS_SELECTOR = 0xc08,
    HOST_GS_SELECTOR = 0xc0a,
    HOST_TR_SELECTOR = 0xc0c,

    // 64-Bit Control
    CONTROL_IO_BITMAP_A_ADDRESS = 0x2000,
    CONTROL_IO_BITMAP_B_ADDRESS = 0x2002,
    CONTROL_MSR_BITMAP_ADDRESS = 0x2004,
    CONTROL_VMEXIT_MSR_STORE_ADDR = 0x2006,
    CONTROL_VMEXIT_MSR_LOAD_ADDR = 0x2008,
    CONTROL_VMENTRY_MSR_LOAD_ADDR = 0x200a,
    CONTROL_EXECUTIVE_VMCS_PTR = 0x200c,
    CONTROL_TSC_OFFSET = 0x2010,
    CONTROL_VIRTUAL_APIC_ADDRESS = 0x2012,

    // 64-Bit Guest State
    GUEST_VMCS_LINK_PTR = 0x2800,
    GUEST_DEBUGCTL = 0x2802,
    GUEST_PAT = 0x2804,
    GUEST_EFER = 0x2806,
    GUEST_PERF_GLOBAL_CTRL = 0x2808,
    GUEST_PDPTR0 = 0x280a,
    GUEST_PDPTR1 = 0x280c,
    GUEST_PDPTR2 = 0x280e,
    GUEST_PDPTR3 = 0x2810,

    // 64-Bit Host State
    HOST_PAT = 0x2c00,
    HOST_EFER = 0x2c02,
    HOST_PERF_GLOBAL_CTRL = 0x2c04,

    // 32-Bit Control
    CONTROL_PIN_BASED_VM_EXECUTION_CONTROLS = 0x4000,
    CONTROL_PRIMARY_PROCESSOR_BASED_VM_EXECUTION_CONTROLS = 0x4002,
    CONTROL_EXCEPTION_BITMAP = 0x4004,
    CONTROL_PAGE_FAULT_ERROR_CODE_MASK = 0x4006,
    CONTROL_PAGE_FAULT_ERROR_CODE_MATCH = 0x4008,
    CONTROL_CR3_TARGET_COUNT = 0x400a,
    CONTROL_VM_EXIT_CONTROLS = 0x400c,
    CONTROL_VM_EXIT_MSR_STORE_COUNT = 0x400e,
    CONTROL_VM_EXIT_MSR_LOAD_COUNT = 0x4010,
    CONTROL_VM_ENTRY_CONTROLS = 0x4012,
    CONTROL_VM_ENTRY_MSR_LOAD_COUNT = 0x4014,
    CONTROL_VM_ENTRY_INTR_INFO_FIELD = 0x4016,
    CONTROL_VM_ENTRY_EXCEPTION_ERROR_CODE = 0x4018,
    CONTROL_VM_ENTRY_INSTRUCTION_LENGTH = 0x401a,
    CONTROL_TPR_THRESHOLD = 0x401c,
    CONTROL_SECONDARY_PROCESSOR_BASED_VM_EXECUTION_CONTROLS = 0x401e,

    // 32-Bit Read-Only
    VM_INSTRUCTION_ERROR = 0x4400,
    VM_EXIT_REASON = 0x4402,
    VM_EXIT_INTR_INFO = 0x4404,
    VM_EXIT_INTR_ERROR_CODE = 0x4406,
    VM_EXIT_IDT_VECTORING_INFO = 0x4408,
    VM_EXIT_IDT_VECTORING_ERROR_CODE = 0x440a,
    VM_EXIT_INSTRUCTION_LEN = 0x440c,
    VM_EXIT_INSTRUCTION_INFO = 0x440e,

    // 32-Bit Guest State
    GUEST_ES_LIMIT = 0x4800,
    GUEST_CS_LIMIT = 0x4802,
    GUEST_SS_LIMIT = 0x4804,
    GUEST_DS_LIMIT = 0x4806,
    GUEST_FS_LIMIT = 0x4808,
    GUEST_GS_LIMIT = 0x480a,
    GUEST_LDTR_LIMIT = 0x480c,
    GUEST_TR_LIMIT = 0x480e,
    GUEST_GDTR_LIMIT = 0x4810,
    GUEST_IDTR_LIMIT = 0x4812,
    GUEST_ES_AR_BYTES = 0x4814,
    GUEST_CS_AR_BYTES = 0x4816,
    GUEST_SS_AR_BYTES = 0x4818,
    GUEST_DS_AR_BYTES = 0x481a,
    GUEST_FS_AR_BYTES = 0x481c,
    GUEST_GS_AR_BYTES = 0x481e,
    GUEST_LDTR_AR_BYTES = 0x4820,
    GUEST_TR_AR_BYTES = 0x4822,
    GUEST_INTERRUPTIBILITY_INFO = 0x4824,
    GUEST_ACTIVITY_STATE = 0x4826,
    GUEST_SM_BASE = 0x4828,
    GUEST_SYSENTER_CS = 0x482a,

    // 32-Bit Host State
    HOST_IA32_SYSENTER_CS = 0x4c00,

    // Natural-Width Control
    CONTROL_CR0_GUEST_HOST_MASK = 0x6000,
    CONTROL_CR4_GUEST_HOST_MASK = 0x6002,
    CONTROL_CR0_READ_SHADOW = 0x6004,
    CONTROL_CR4_READ_SHADOW = 0x6006,
    CONTROL_CR3_TARGET_VALUE0 = 0x6008,
    CONTROL_CR3_TARGET_VALUE1 = 0x600a,
    CONTROL_CR3_TARGET_VALUE2 = 0x600c,
    CONTROL_CR3_TARGET_VALUE3 = 0x600e,

    // Natural-Width Read-Only
    EXIT_QUALIFICATION = 0x6400,
    IO_RCX = 0x6402,
    IO_RSI = 0x6404,
    IO_RDI = 0x6406,
    IO_RIP = 0x6408,
    GUEST_LINEAR_ADDRESS = 0x640a,

    // Natural-Width Guest State
    GUEST_CR0 = 0x6800,
    GUEST_CR3 = 0x6802,
    GUEST_CR4 = 0x6804,
    GUEST_ES_BASE = 0x6806,
    GUEST_CS_BASE = 0x6808,
    GUEST_SS_BASE = 0x680a,
    GUEST_DS_BASE = 0x680c,
    GUEST_FS_BASE = 0x680e,
    GUEST_GS_BASE = 0x6810,
    GUEST_LDTR_BASE = 0x6812,
    GUEST_TR_BASE = 0x6814,
    GUEST_GDTR_BASE = 0x6816,
    GUEST_IDTR_BASE = 0x6818,
    GUEST_DR7 = 0x681a,
    GUEST_RSP = 0x681c,
    GUEST_RIP = 0x681e,
    GUEST_RFLAGS = 0x6820,
    GUEST_PENDING_DBG_EXCEPTIONS = 0x6822,
    GUEST_SYSENTER_ESP = 0x6824,
    GUEST_SYSENTER_EIP = 0x6826,

    // Natural-Width Host State
    HOST_CR0 = 0x6c00,
    HOST_CR3 = 0x6c02,
    HOST_CR4 = 0x6c04,
    HOST_FS_BASE = 0x6c06,
    HOST_GS_BASE = 0x6c08,
    HOST_TR_BASE = 0x6c0a,
    HOST_GDTR_BASE = 0x6c0c,
    HOST_IDTR_BASE = 0x6c0e,
    HOST_IA32_SYSENTER_ESP = 0x6c10,
    HOST_IA32_SYSENTER_EIP = 0x6c12,
    HOST_RSP = 0x6c14,
    HOST_RIP = 0x6c16
};

// State Structure
typedef struct VCPU_CONTEXT {
    UINT64 VmxOnPhys;
    PVOID  VmxOnVirt;

    UINT64 VmcsPhys;
    PVOID  VmcsVirt;

    PVOID  HostStack;
    UINT64 HostStackTop;

    PVOID  MsrBitmap;
    UINT64 MsrBitmapPhys;

    BOOLEAN IsLaunched;
} VCPU_CONTEXT, *PVCPU_CONTEXT;